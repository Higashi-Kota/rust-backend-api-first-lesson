# マルチテナント機能要件定義

## 背景
現在のシステムではタスクは完全にユーザー個人のリソースとして管理されており、チームや組織単位でのデータ共有・協業ができない。チーム・組織への所属管理機能は実装済みだが、これを活用したリソース共有機能が未実装である。

## 現在の権限制御マトリクス

### 1. システムレベル権限
| ロール | 説明 | 権限範囲 |
|--------|------|----------|
| Admin | システム管理者 | 全リソースへの完全なアクセス権 |
| Member | 一般ユーザー | 自身のリソースのみアクセス可能 |

### 2. 組織レベル権限
| ロール | 権限レベル | 組織管理 | メンバー管理 | チーム作成 | 分析閲覧 |
|--------|------------|----------|--------------|------------|----------|
| Owner | 最上位 | ✓ | ✓ | ✓ | ✓ |
| Admin | 管理者 | ✓ | ✓ | ✓ | ✓ |
| Member | 一般 | × | × | △※1 | △※2 |

※1 組織の設定により制限可能
※2 自身が関わるデータのみ

### 3. チームレベル権限
| ロール | 権限レベル | チーム設定 | メンバー管理 | リソース作成 | リソース閲覧 | リソース編集 | リソース削除 |
|--------|------------|------------|--------------|--------------|--------------|--------------|--------------|
| Owner | 最上位 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| Admin | 管理者 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| Member | 一般 | × | × | ✓ | ✓ | △※3 | △※3 |
| Viewer | 閲覧のみ | × | × | × | ✓ | × | × |

※3 自身が作成したリソースのみ、またはチーム設定による

### 4. 部署レベル権限
| ロール | 権限レベル | 部署管理 | メンバー管理 | リソースアクセス |
|--------|------------|----------|--------------|------------------|
| Manager | 管理者 | ✓ | ✓ | ✓ |
| Lead | リーダー | △ | △ | ✓ |
| Member | 一般 | × | × | ✓ |
| Viewer | 閲覧のみ | × | × | △（閲覧のみ） |

### 5. 権限の優先順位
1. **システムAdmin** > すべての権限（最優先）
2. **組織Owner** > 組織内のすべての権限
3. **組織Admin** ≈ 組織Owner（一部制限あり）
4. **チームOwner** > チーム内のすべての権限
5. **チームAdmin** ≈ チームOwner（一部制限あり）
6. **部署Manager** > 部署内の管理権限
7. その他のロールは上記の階層に従う

## マルチテナント機能要件

### 1. チーム共有タスク機能
- **要件**
  - チームに紐づくタスクの作成・管理機能
  - タスクの可視性設定（個人/チーム/組織）
  - チームメンバーへのタスク割り当て機能
  - チーム内でのタスク引き継ぎ機能

### 2. アクセススコープ機能
- **要件**
  - タスク一覧取得時のスコープ指定
    - personal: 自分のタスクのみ（デフォルト）
    - team: 指定チームのタスク
    - organization: 所属組織全体のタスク
  - ユーザーの所属に基づくアクセス制御
  - 複数チーム所属時の適切なフィルタリング

### 3. 権限ベースの操作制御
- **要件**
  - チームロールに基づく操作権限
    - Owner/Admin: チームタスクの完全な管理権限
    - Member: チームタスクの閲覧、自身の担当タスクの編集
    - Viewer: チームタスクの閲覧のみ
  - 組織ロールによる上位権限
    - 組織Owner/Admin: 組織内全タスクへのアクセス
  - 権限継承の明確化

### 4. タスク所有権モデルの拡張
- **要件**
  - タスクの所有者タイプ（個人/チーム/組織）
  - 複数の所有者モデルの共存
  - 既存の個人タスクとの後方互換性

### 5. 監査・セキュリティ要件
- **要件**
  - アクセスログの記録
  - 権限変更の追跡
  - 不正アクセスの防止
  - データ分離の保証

### 6. パフォーマンス要件
- **要件**
  - 大規模チーム（1000人以上）での応答性能
  - 効率的なクエリによるDB負荷軽減
  - 適切なインデックス設計

## 移行計画

### フェーズ1: データモデル拡張
- タスクテーブルへのチーム/組織関連フィールド追加
- 既存データの移行戦略

### フェーズ2: API拡張
- スコープ付きタスク取得API
- チームタスク管理API

### フェーズ3: 権限制御統合
- 統一権限チェックミドルウェアの適用
- 既存APIの権限制御リファクタリング

## 成功基準
1. チームメンバー間でタスクを共有・協業できる
2. 権限に基づいた適切なアクセス制御が機能する
3. 既存の個人タスク機能に影響を与えない
4. パフォーマンスの劣化がない
5. セキュリティ上の問題がない