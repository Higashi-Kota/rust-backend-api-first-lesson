# マルチテナント機能要件定義

## 背景
現在のシステムではタスクは完全にユーザー個人のリソースとして管理されており、チームや組織単位でのデータ共有・協業ができない。チーム・組織への所属管理機能は実装済みだが、これを活用したリソース共有機能が未実装である。

## 実現トピック: 権限チェックパターンの統一 🔴

### 現状の課題
- PermissionService使用と直接ロールチェックが混在
- リソース名が不統一
- ハンドコードされた権限チェックロジックが散在

### 解決方法: 統一権限チェックミドルウェアとマクロ

```rust
// src/middleware/authorization.rs
pub struct RequirePermission {
    resource: &'static str,
    action: Action,
}

// 権限チェックマクロ
#[macro_export]
macro_rules! require_permission {
    ($resource:expr, $action:expr) => {
        move |req: Request, next: Next| async move {
            // 権限チェックロジック
        }
    };
}

// リソース名定数
pub mod resources {
    pub const TASK: &str = "task";
    pub const TEAM: &str = "team";
    pub const USER: &str = "user";
    pub const ORGANIZATION: &str = "organization";
}
```

## 現在の権限制御マトリクス

### 1. システムレベル権限
| ロール | 説明 | 権限範囲 |
|--------|------|----------|
| Admin | システム管理者 | 全リソースへの完全なアクセス権 |
| Member | 一般ユーザー | 自身のリソースのみアクセス可能 |

### 2. 組織レベル権限
| ロール | 権限レベル | 組織管理 | メンバー管理 | チーム作成 | 分析閲覧 |
|--------|------------|----------|--------------|------------|----------|
| Owner | 最上位 | ✓ | ✓ | ✓ | ✓ |
| Admin | 管理者 | ✓ | ✓ | ✓ | ✓ |
| Member | 一般 | × | × | △※1 | △※2 |

※1 組織の設定により制限可能
※2 自身が関わるデータのみ

### 3. チームレベル権限
| ロール | 権限レベル | チーム設定 | メンバー管理 | リソース作成 | リソース閲覧 | リソース編集 | リソース削除 |
|--------|------------|------------|--------------|--------------|--------------|--------------|--------------|
| Owner | 最上位 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| Admin | 管理者 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| Member | 一般 | × | × | ✓ | ✓ | △※3 | △※3 |
| Viewer | 閲覧のみ | × | × | × | ✓ | × | × |

※3 自身が作成したリソースのみ、またはチーム設定による

### 4. 部署レベル権限
| ロール | 権限レベル | 部署管理 | メンバー管理 | リソースアクセス |
|--------|------------|----------|--------------|------------------|
| Manager | 管理者 | ✓ | ✓ | ✓ |
| Lead | リーダー | △ | △ | ✓ |
| Member | 一般 | × | × | ✓ |
| Viewer | 閲覧のみ | × | × | △（閲覧のみ） |

### 5. 権限の優先順位
1. **システムAdmin** > すべての権限（最優先）
2. **組織Owner** > 組織内のすべての権限
3. **組織Admin** ≈ 組織Owner（一部制限あり）
4. **チームOwner** > チーム内のすべての権限
5. **チームAdmin** ≈ チームOwner（一部制限あり）
6. **部署Manager** > 部署内の管理権限
7. その他のロールは上記の階層に従う

## マルチテナント機能要件

### 1. チーム共有タスク機能
- **要件**
  - チームに紐づくタスクの作成・管理機能
  - タスクの可視性設定（個人/チーム/組織）
  - チームメンバーへのタスク割り当て機能
  - チーム内でのタスク引き継ぎ機能

### 2. アクセススコープ機能
- **要件**
  - タスク一覧取得時のスコープ指定
    - personal: 自分のタスクのみ（デフォルト）
    - team: 指定チームのタスク
    - organization: 所属組織全体のタスク
  - ユーザーの所属に基づくアクセス制御
  - 複数チーム所属時の適切なフィルタリング

### 3. 権限ベースの操作制御
- **要件**
  - チームロールに基づく操作権限
    - Owner/Admin: チームタスクの完全な管理権限
    - Member: チームタスクの閲覧、自身の担当タスクの編集
    - Viewer: チームタスクの閲覧のみ
  - 組織ロールによる上位権限
    - 組織Owner/Admin: 組織内全タスクへのアクセス
  - 権限継承の明確化

### 4. タスク所有権モデルの拡張
- **要件**
  - タスクの所有者タイプ（個人/チーム/組織）
  - 複数の所有者モデルの共存
  - 既存の個人タスクとの後方互換性

### 5. 監査・セキュリティ要件
- **要件**
  - アクセスログの記録
  - 権限変更の追跡
  - 不正アクセスの防止
  - データ分離の保証

### 6. パフォーマンス要件
- **要件**
  - 大規模チーム（1000人以上）での応答性能
  - 効率的なクエリによるDB負荷軽減
  - 適切なインデックス設計

## 実装方針（CLAUDE.mdガイドラインに準拠）

### 1. ドメイン統合の原則
- 既存ドメインとの重複・競合は禁止
- APIのスラグなど機能別の統一感を意識
- パスパラメータは `{param}` 形式を使用（Axum 0.8の仕様）
- 「亜種」API・ドメイン定義の増加は避ける

### 2. エラーハンドリング
- エラーコンテキストの命名規則: `"モジュール名::関数名[:詳細]"`
- すべてのサービス層でerror_helper関数を使用
- 構造化ログによる本番環境でのデバッグ・監視

### 3. データベース設計
- テーブル名は必ず複数形（`tasks`, `team_tasks` など）
- 標準カラム: `id` (UUID型), `created_at`, `updated_at`
- タイムスタンプは必ず `TIMESTAMPTZ` 型を使用
- マイグレーションファイル命名規則: `m{YYYYMMDD}_{連番6桁}_{説明}.rs`

### 4. API設計
- `/api/` プレフィックスは使用しない
- `/v1/`,`/v数値/` プレフィックスは使用しない
- 管理者専用APIは `/admin/*` で統一
- 日時フィールドはUnix Timestamp（秒単位）で統一
- CORS設定は環境変数で管理

### 5. テスト要件
- AAA（Arrange-Act-Assert）パターンによる統合テスト実装
- 各APIエンドポイントに対して最低限以下のケースをテスト:
  - 正常系
  - バリデーションエラー
  - 認証エラー
  - 認可エラー
  - リソース不在
- 実データによる検証（モックやハードコード値を避ける）
- テスト間の独立性を確保

## 移行計画

### フェーズ1: 統一権限チェックミドルウェアの実装
- RequirePermissionミドルウェアの実装
- リソース名定数の定義
- 既存APIへの適用と統廃合（v2スラグなどを新規に生やさずに既存の拡張）

### フェーズ2: データモデル拡張
- タスクテーブルへのチーム/組織関連フィールド追加
- 既存データの移行戦略
- 適切なインデックス設計

### フェーズ3: API拡張
- スコープ付きタスク取得API
- チームタスク管理API
- 権限に基づくフィルタリング

### フェーズ4: 統合テスト充実
- マルチテナント機能の網羅的テスト
- チーム間のデータ分離テスト
- パフォーマンステスト

### フェーズ5: UI/UX対応
- チーム/個人タスクの切り替えUI
- 権限に基づく操作ボタンの表示制御

## 成功基準
1. チームメンバー間でタスクを共有・協業できる
2. 権限に基づいた適切なアクセス制御が機能する
3. 既存の個人タスク機能に影響を与えない
4. パフォーマンスの劣化がない
5. セキュリティ上の問題がない
6. `cargo clippy`で警告ゼロ
7. `make ci-check-fast`ですべてのテストがグリーン