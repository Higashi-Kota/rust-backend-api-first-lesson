## 実現トピック

### 📊 統合テストの拡充と機能重複の解消

#### 🎯 目的
1. **統合テストカバレッジの向上**
   - 既存APIの網羅的なテスト
   - エッジケースとエラーパスの検証
   - 権限チェックの完全性確認

2. **機能重複の解消**
   - 類似機能の統合
   - セマンティックな整理
   - APIエンドポイントの最適化

#### 📋 実装計画

##### Phase 1: 現状分析（統合テストのカバレッジ確認）
1. **既存統合テストの棚卸し**
   - 各APIエンドポイントのテスト有無確認
   - テストパターン（正常系、異常系、権限系）の確認
   - 不足しているテストケースの特定

2. **APIエンドポイントのマッピング**
   ```
   - /auth/* - 認証関連
   - /users/* - ユーザー管理
   - /roles/* - ロール管理
   - /tasks/* - タスク管理
   - /teams/* - チーム管理
   - /organizations/* - 組織管理
   - /permissions/* - 権限管理
   - /analytics/* - 分析
   - /admin/* - 管理者機能
   - /gdpr/* - GDPR対応
   ```

##### Phase 2: 機能重複の調査と統合
1. **重複機能の特定**
   - 類似エンドポイントの洗い出し
   - 同じ目的の異なる実装パターン
   - DTOとモデルの重複確認

2. **統合候補の例**
   - ユーザー一覧取得APIの統合
     - `GET /users` (一般)
     - `GET /admin/users` (管理者用)
     - → 権限によるフィルタリングで統一
   
   - 権限チェック機能の統合
     - 個別の権限チェックメソッド
     - → 統一された権限チェックサービス

##### Phase 3: 統合テストの実装
1. **必須テストパターン（各APIごと）**
   ```rust
   // 1. 正常系
   #[tokio::test]
   async fn test_api_success() { }
   
   // 2. バリデーションエラー
   #[tokio::test]
   async fn test_api_invalid_input() { }
   
   // 3. 認証エラー
   #[tokio::test]
   async fn test_api_unauthorized() { }
   
   // 4. 権限エラー
   #[tokio::test]
   async fn test_api_forbidden() { }
   
   // 5. リソース不在
   #[tokio::test]
   async fn test_api_not_found() { }
   ```

2. **優先順位の高いテスト領域**
   - 組織管理API（新規実装）
   - チーム管理API（招待フロー）
   - 権限管理API（複雑なロジック）
   - GDPR関連API（コンプライアンス）

##### Phase 4: セマンティックな整理
1. **APIの責務明確化**
   - 各エンドポイントの単一責任原則
   - RESTfulな設計の徹底
   - 命名規則の統一

2. **エラーレスポンスの統一**
   - 一貫したエラー構造
   - 適切なHTTPステータスコード
   - 有用なエラーメッセージ

#### 🏁 完了基準
1. **すべての公開APIに統合テストが存在**
2. **各APIに最低5パターンのテスト**（上記必須パターン）
3. **機能重複が解消され、シンプルなAPI構造**
4. **ドキュメントとテストが同期**
5. **CI/CDパイプラインですべてのテストが通過**

#### 📈 メトリクス
- テストカバレッジ: 80%以上
- 統合テスト数: 各API × 5パターン以上
- API応答時間: 200ms以下（95パーセンタイル）
- エラーレート: 0.1%以下

## 🧩 実装ガイドライン

### 1. **ドメイン統合の原則**

* **既存ドメインとの重複・競合は禁止**
  * 同じ意味の別表現、似たが異なるロジック、バリエーション増加は避ける
  * APIのスラグなど機能別の統一感を意識
  * APIのスラグなどルーティングの重複排除＆集約統合を意識
* **「亜種」API・ドメイン定義の増加は避ける**
  * 新規定義が必要な場合は、**既存の責務・境界に統合**できるか再検討

### 2. **dead\_code ポリシー**

* `#![allow(dead_code)]` や `#[allow(dead_code)]` の**新規追加は禁止**
* **既存アノテーションからAPIとして価値提供できる場合は積極的に外す**
  * 新規APIには統合テストを実施
    ```rust
    // 必須: 3パターンのテスト
    #[tokio::test]
    async fn test_feature_success() { /* 正常系 */ }

    #[tokio::test]
    async fn test_feature_invalid_data() { /* 異常系 */ }

    #[tokio::test]
    async fn test_feature_forbidden() { /* 権限エラー */ }
    ```
  * 必要に応じてマイグレーションによるDB設計も考慮
* **未使用コード・シグネチャ・構造体は削除**
  * ただし、テストで使用されているコードは、実装で適切に活用する

### 3. **プロダクションコードの品質基準**

* **すべての公開APIは実装で使用される**こと
* **テストは実装の動作を検証**するものであること
* **未使用の警告が出ないこと**（dead_code警告を含む）

### 4. **CI・Lint 要件**

* 以下のコマンドで **エラー・警告が完全にゼロ** であること：

  ```bash
  cargo clippy --all-targets --all-features -- -D warnings
  ```

* 既存CI（テスト）コマンド：

  ```bash
  make ci-check
  ```

  → **すべてのテストにパスすること（新旧含む）**

---

## 🧪 テスト要件

### 単体テスト（Unit Test）

* **新規ロジックに対する細粒度のテストを実装**

  * 条件分岐、バリデーション、エラーケースなどを網羅
  * 概念テスト・型だけのテストは不可

### 統合テスト（Integration Test）

* APIレベルでの**E2Eフロー確認**

  * リクエスト／レスポンス構造の妥当性
  * DB書き込み・読み出しの整合性
  * エラーハンドリングの検証

---

## 🔥 クリーンアップ方針

* **使用されていないコード**の取り扱い：
  1. **テストでのみ使用** → 実装で活用するよう統合
  2. **どこでも未使用** → 削除
  3. **将来の拡張用** → 現時点で価値提供できるよう実装

* dead\_code で検知される要素への対応：
  * **公開API（pub）** → 実装での活用を検討
  * **内部実装（非pub）** → 使用されていなければ削除
  * **テスト用ユーティリティ** → そのまま維持

---

## 🚀 実装完了後の期待される状態

1. **`cargo clippy`で警告ゼロ**（dead_code警告を含む）
2. **`make ci-check`ですべてのテストがグリーン**
3. **APIドキュメントと実装が一致**
4. **テストが実装の実際の動作を検証**
5. **プロダクションコードがクリーンで保守しやすい**

---

