# âœ… Phase 3 å®Ÿè£…è¨ˆç”»

Phase 1ã§åŸºæœ¬çš„ãªæ©Ÿèƒ½çµ±åˆã‚’å®Œäº†ã—ã€Phase 2ã§æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¨èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆã‚’é”æˆã—ã¾ã—ãŸã€‚Phase 3ã§ã¯ã€æ®‹ã‚Šç´„80ç®‡æ‰€ã®`#[allow(dead_code)]`ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã¨ãƒªãƒã‚¸ãƒˆãƒªå±¤ã®é«˜åº¦ãªæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

---

## ğŸ“Œ Phase 3 é‡ç‚¹å®Ÿè£…å¯¾è±¡

### 1. **APIã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€**ï¼ˆå„ªå…ˆåº¦ï¼šé«˜ - 9ç®‡æ‰€ï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `task-backend/src/api/dto/common.rs`
- [ ] `ApiError::new` - åŸºæœ¬ã‚¨ãƒ©ãƒ¼ç”Ÿæˆ
- [ ] `ApiError::with_details` - è©³ç´°ä»˜ãã‚¨ãƒ©ãƒ¼  
- [ ] `ApiError::validation_error` - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
- [ ] å„ç¨®ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆunauthorized, forbidden, not_foundç­‰ï¼‰
- [ ] ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®è©³ç´°åŒ–

### 2. **ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®é«˜åº¦åŒ–**ï¼ˆç´„25ç®‡æ‰€ï¼‰
**ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«**:
- `domain/role_model.rs` (5ç®‡æ‰€)
- `domain/organization_model.rs` (4ç®‡æ‰€)
- `domain/team_invitation_model.rs` (5ç®‡æ‰€)
- `domain/subscription_history_model.rs` (2ç®‡æ‰€)
- ãã®ä»–ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«

**å®Ÿè£…å†…å®¹**:
- [ ] ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®æ¨©é™ç¶™æ‰¿ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
- [ ] çµ„ç¹”éšå±¤ã®æ¨©é™ä¼æ’­
- [ ] æ‹›å¾…çŠ¶æ…‹ç®¡ç†ã®é«˜åº¦åŒ–
- [ ] ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å±¥æ­´ã®åˆ†ææ©Ÿèƒ½

### 3. **ãƒªãƒã‚¸ãƒˆãƒªå±¤ã®æœ€é©åŒ–**ï¼ˆç´„15ç®‡æ‰€ï¼‰
**ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«**:
- `repository/organization_repository.rs` (2ç®‡æ‰€)
- `repository/subscription_history_repository.rs` (2ç®‡æ‰€)
- `repository/email_verification_token_repository.rs` (2ç®‡æ‰€)
- ãã®ä»–ã®ãƒªãƒã‚¸ãƒˆãƒª

**å®Ÿè£…å†…å®¹**:
- [ ] ãƒãƒƒãƒå‡¦ç†ã®æœ€é©åŒ–
- [ ] ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„
- [ ] ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã®é©åˆ‡ãªè¨­å®š
- [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã®å¼·åŒ–

### 4. **ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£æ©Ÿèƒ½ã®å®Œå…¨çµ±åˆ**ï¼ˆç´„18ç®‡æ‰€ï¼‰
**ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«**:
- `utils/transaction.rs` (4ç®‡æ‰€) - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
- `utils/email.rs` (3ç®‡æ‰€) - ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½
- `utils/password.rs` (1ç®‡æ‰€) - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼

**å®Ÿè£…å†…å®¹**:
- [ ] åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚µãƒãƒ¼ãƒˆ
- [ ] ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å‹•çš„ç”Ÿæˆ
- [ ] ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ã®è©³ç´°è¨­å®š

---

## ğŸ§© å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### 1. **ãƒ‰ãƒ¡ã‚¤ãƒ³çµ±åˆã®åŸå‰‡**

* **æ—¢å­˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã®é‡è¤‡ãƒ»ç«¶åˆã¯ç¦æ­¢**
  * åŒã˜æ„å‘³ã®åˆ¥è¡¨ç¾ã€ä¼¼ãŸãŒç•°ãªã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã€ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å¢—åŠ ã¯é¿ã‘ã‚‹
* **ã€Œäºœç¨®ã€APIãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³å®šç¾©ã®å¢—åŠ ã¯é¿ã‘ã‚‹**
  * æ–°è¦å®šç¾©ãŒå¿…è¦ãªå ´åˆã¯ã€**æ—¢å­˜ã®è²¬å‹™ãƒ»å¢ƒç•Œã«çµ±åˆ**ã§ãã‚‹ã‹å†æ¤œè¨

### 2. **dead\_code ãƒãƒªã‚·ãƒ¼**

* `#![allow(dead_code)]` ã‚„ `#[allow(dead_code)]` ã®**æ–°è¦è¿½åŠ ã¯ç¦æ­¢**
* **æ—¢å­˜ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰APIã¨ã—ã¦ä¾¡å€¤æä¾›ã§ãã‚‹å ´åˆã¯ç©æ¥µçš„ã«å¤–ã™**
* **æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ãƒ»ã‚·ã‚°ãƒãƒãƒ£ãƒ»æ§‹é€ ä½“ã¯å‰Šé™¤**
  * ãŸã ã—ã€ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ã€å®Ÿè£…ã§é©åˆ‡ã«æ´»ç”¨ã™ã‚‹

### 3. **ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®å“è³ªåŸºæº–**

* **ã™ã¹ã¦ã®å…¬é–‹APIã¯å®Ÿè£…ã§ä½¿ç”¨ã•ã‚Œã‚‹**ã“ã¨
* **ãƒ†ã‚¹ãƒˆã¯å®Ÿè£…ã®å‹•ä½œã‚’æ¤œè¨¼**ã™ã‚‹ã‚‚ã®ã§ã‚ã‚‹ã“ã¨
* **æœªä½¿ç”¨ã®è­¦å‘ŠãŒå‡ºãªã„ã“ã¨**ï¼ˆdead_codeè­¦å‘Šã‚’å«ã‚€ï¼‰

### 4. **å®Ÿè£…çµ±åˆã®å„ªå…ˆé †ä½**

1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£æ©Ÿèƒ½**ï¼ˆæ¨©é™ãƒã‚§ãƒƒã‚¯ã€èªè¨¼ï¼‰
2. **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§æ©Ÿèƒ½**ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã€ãƒªãƒˆãƒ©ã‚¤ï¼‰
3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Šæ©Ÿèƒ½**ï¼ˆè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼‰
4. **é‹ç”¨æ”¯æ´æ©Ÿèƒ½**ï¼ˆãƒ­ã‚°ã€ç›£æŸ»è¨¼è·¡ï¼‰

### 5. **CIãƒ»Lint è¦ä»¶**

* ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ **ã‚¨ãƒ©ãƒ¼ãƒ»è­¦å‘ŠãŒå®Œå…¨ã«ã‚¼ãƒ­** ã§ã‚ã‚‹ã“ã¨ï¼š

  ```bash
  cargo clippy --all-targets --all-features -- -D warnings
  ```

* æ—¢å­˜CIï¼ˆãƒ†ã‚¹ãƒˆï¼‰ã‚³ãƒãƒ³ãƒ‰ï¼š

  ```bash
  make ci-check
  ```

  â†’ **ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã«ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ï¼ˆæ–°æ—§å«ã‚€ï¼‰**

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆè¦ä»¶

### å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆUnit Testï¼‰

* **æ–°è¦ãƒ­ã‚¸ãƒƒã‚¯ã«å¯¾ã™ã‚‹ç´°ç²’åº¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…**

  * æ¡ä»¶åˆ†å²ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ãªã©ã‚’ç¶²ç¾…
  * æ¦‚å¿µãƒ†ã‚¹ãƒˆãƒ»å‹ã ã‘ã®ãƒ†ã‚¹ãƒˆã¯ä¸å¯

### çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆIntegration Testï¼‰

* APIãƒ¬ãƒ™ãƒ«ã§ã®**E2Eãƒ•ãƒ­ãƒ¼ç¢ºèª**

  * ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã®å¦¥å½“æ€§
  * DBæ›¸ãè¾¼ã¿ãƒ»èª­ã¿å‡ºã—ã®æ•´åˆæ€§
  * ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ¤œè¨¼

---

## ğŸ”¥ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ–¹é‡

* **ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ã‚³ãƒ¼ãƒ‰**ã®å–ã‚Šæ‰±ã„ï¼š
  1. **ãƒ†ã‚¹ãƒˆã§ã®ã¿ä½¿ç”¨** â†’ å®Ÿè£…ã§æ´»ç”¨ã™ã‚‹ã‚ˆã†çµ±åˆ
  2. **ã©ã“ã§ã‚‚æœªä½¿ç”¨** â†’ å‰Šé™¤
  3. **å°†æ¥ã®æ‹¡å¼µç”¨API** â†’ ç¾æ™‚ç‚¹ã§ä¾¡å€¤æä¾›ã§ãã‚‹ã‚ˆã†å®Ÿè£…

* dead\_code ã§æ¤œçŸ¥ã•ã‚Œã‚‹è¦ç´ ã¸ã®å¯¾å¿œï¼š
  * **å…¬é–‹APIï¼ˆpubï¼‰** â†’ å®Ÿè£…ã§ã®æ´»ç”¨ã‚’æ¤œè¨
  * **å†…éƒ¨å®Ÿè£…ï¼ˆépubï¼‰** â†’ ä½¿ç”¨ã•ã‚Œã¦ã„ãªã‘ã‚Œã°å‰Šé™¤
  * **ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£** â†’ `#[cfg(test)]` ã§é©åˆ‡ã«åˆ†é›¢

---

## ğŸ“‹ å®Ÿè£…ä¾‹

### 1. **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã®æ´»ç”¨ä¾‹**

```rust
// âŒ ç¾åœ¨ã®å®Ÿè£…ï¼ˆåŸºæœ¬çš„ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ï¼‰
pub async fn create_team_with_members(&self, ...) -> AppResult<Team> {
    self.db.execute_service_transaction(move |txn| {
        // ãƒãƒ¼ãƒ ä½œæˆã¨ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ 
    }).await
}

// âœ… æ”¹å–„å¾Œï¼ˆTransactionOperationsã‚’æ´»ç”¨ï¼‰
pub async fn create_team_with_members(&self, ...) -> AppResult<Team> {
    self.db.execute_service_transaction(move |txn| {
        let ops = TransactionOperations::new(txn);
        
        // æ“ä½œ1: ãƒãƒ¼ãƒ ä½œæˆ
        let team = ops.execute("create_team", 
            team_repo.create_team(&team_data)
        ).await?;
        
        // æ“ä½œ2: ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ 
        ops.execute("add_members", 
            team_repo.add_members(&member_data)
        ).await?;
        
        Ok(team)
    }).await
}
```

### 2. **æ¨©é™ãƒã‚§ãƒƒã‚¯ã®æ´»ç”¨ä¾‹**

```rust
// âŒ ç¾åœ¨ã®å®Ÿè£…ï¼ˆåŸºæœ¬çš„ãªæ¨©é™ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼‰
if user.is_admin() {
    // å‡¦ç†
}

// âœ… æ”¹å–„å¾Œï¼ˆè©³ç´°ãªæ¨©é™ãƒã‚§ãƒƒã‚¯ï¼‰
if user.can_update_resource("team", Some(team.owner_id)) {
    // ã‚ˆã‚Šç´°ã‹ã„æ¨©é™åˆ¶å¾¡
}

// å‹•çš„æ¨©é™ãƒã‚§ãƒƒã‚¯
match user.can_perform_action("team", "invite_member", Some(team_id)) {
    PermissionResult::Allowed { scope, .. } => {
        // ã‚¹ã‚³ãƒ¼ãƒ—ã«å¿œã˜ãŸå‡¦ç†
    }
    PermissionResult::Denied { reason } => {
        return Err(AppError::forbidden(reason));
    }
}
```

### 3. **APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ´»ç”¨ä¾‹**

```rust
// âŒ ç¾åœ¨ã®å®Ÿè£…ï¼ˆåŸºæœ¬çš„ãªJSONè¿”å´ï¼‰
Ok(Json(TeamResponse { team }))

// âœ… æ”¹å–„å¾Œï¼ˆè©³ç´°ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰
Ok(Json(ApiResponse::success_with_metadata(
    "Team created successfully",
    TeamResponse { team },
    json!({
        "members_added": member_count,
        "subscription_tier": team.subscription_tier,
        "features_enabled": team_features
    })
)))
```

---

## ğŸš€ å®Ÿè£…å®Œäº†å¾Œã®æœŸå¾…ã•ã‚Œã‚‹çŠ¶æ…‹

1. **`cargo clippy`ã§è­¦å‘Šã‚¼ãƒ­**ï¼ˆdead_codeè­¦å‘Šã‚’å«ã‚€ï¼‰
2. **`make ci-check`ã§ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒã‚°ãƒªãƒ¼ãƒ³**
3. **APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨å®Ÿè£…ãŒä¸€è‡´**
4. **ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã®å®Ÿéš›ã®å‹•ä½œã‚’æ¤œè¨¼**
5. **ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ãŒã‚¯ãƒªãƒ¼ãƒ³ã§ä¿å®ˆã—ã‚„ã™ã„**

---

## ğŸ“ˆ é€²æ—çŠ¶æ³

### âœ… Phase 1ï¼ˆå®Œäº†ï¼‰- 2024/12/29
åˆå›ã®å®Ÿè£…ã§ä»¥ä¸‹ã‚’é”æˆï¼š

#### å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½
1. **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†**
   - `execute_with_retry` - RoleServiceã®assign_role_to_userã§æ´»ç”¨

2. **APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°ãƒ¡ã‚½ãƒƒãƒ‰**
   - `ApiResponse::success_message` - user_handler.rsã§æ´»ç”¨
   - `ApiResponse::success_with_metadata` - analytics_handler.rsã§æ´»ç”¨
   - `OperationResult::created` - analytics_handler.rsã®exportæ©Ÿèƒ½ã§æ´»ç”¨
   - `OperationResult::deleted` - organization_hierarchy_handler.rsã§æ´»ç”¨

3. **æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **
   - `has_subscription_tier` - ãƒãƒ¼ãƒ ä½œæˆæ™‚ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³éšå±¤ãƒã‚§ãƒƒã‚¯ï¼ˆ3ãƒãƒ¼ãƒ ã¾ã§ï¼‰
   - `can_access_user` - user_handler.rsã§æ´»ç”¨
   - `can_update_resource` - user_handler.rs, role_service.rsã§æ´»ç”¨
   - `can_create_resource` - role_service.rsã§æ´»ç”¨
   - `can_delete_resource` - role_service.rsã§æ´»ç”¨

#### æˆæœ
- **320å€‹ã®ãƒ†ã‚¹ãƒˆã™ã¹ã¦æˆåŠŸ** âœ…
- **CIå®Œå…¨é€šé** âœ…
- **ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®dead_codeè­¦å‘Šã‚¼ãƒ­** âœ…

### âœ… Phase 2ï¼ˆå®Œäº†ï¼‰- 2024/12/29
æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¨èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆã‚’å®Œäº†ï¼š

#### å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½
1. **Permissionã‚·ã‚¹ãƒ†ãƒ ã®å®Œå…¨çµ±åˆ**ï¼ˆ24ç®‡æ‰€ï¼‰
   - `Permission::new()`, `read_own()`, `write_own()`, `admin_global()` - permission_handler.rsã§æ´»ç”¨
   - `PermissionResult::allowed()`, `denied()` - ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…
   - `PermissionQuota::limited()`, `unlimited()` - ã‚¯ã‚©ãƒ¼ã‚¿è¨­å®šã§æ´»ç”¨
   - `Privilege::free_basic()`, `pro_advanced()`, `enterprise_unlimited()` - éšå±¤åˆ¥æ¨©é™ã§æ´»ç”¨
   - `PermissionScope::description()` - ã‚¹ã‚³ãƒ¼ãƒ—èª¬æ˜ã®è¿½åŠ 

2. **èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®å¼·åŒ–**ï¼ˆ19ç®‡æ‰€ï¼‰
   - `AuthMiddlewareConfig`, `AuthenticatedUser`, `AuthenticatedUserWithRole` - æ§‹é€ ä½“ã‚’å…¬é–‹
   - ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢é–¢æ•°ç¾¤ã‚’å…¬é–‹ï¼ˆ`admin_only_middleware`, `role_aware_auth_middleware`ç­‰ï¼‰
   - ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ã‚’å…¬é–‹ï¼ˆ`is_auth_endpoint`, `extract_client_ip`, `get_authenticated_user`ç­‰ï¼‰
   - æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°ç¾¤ã‚’å…¬é–‹ï¼ˆ`check_resource_access_permission`ç­‰ï¼‰

3. **æ¨©é™ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®çµ±åˆ**ï¼ˆ17ç®‡æ‰€ï¼‰
   - `PermissionChecker::check_scope()` - ã‚¹ã‚³ãƒ¼ãƒ—æ¯”è¼ƒãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
   - æœªä½¿ç”¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®å‰Šé™¤

#### æˆæœ
- **223å€‹ã®ãƒ†ã‚¹ãƒˆã™ã¹ã¦æˆåŠŸ** âœ…
- **CIå®Œå…¨é€šé** âœ…
- **æ®‹å­˜dead_code: ç´„80ç®‡æ‰€**ï¼ˆ120ç®‡æ‰€ã‹ã‚‰å‰Šæ¸›ï¼‰

---

## ğŸš§ Phase 3 å®Ÿè£…æ‰‹é †

### Step 1: ç¾çŠ¶åˆ†æï¼ˆPhase 3å‘ã‘ï¼‰
```bash
# 1. æ®‹å­˜dead_codeã®è©³ç´°åˆ†æ
# ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥çµ±è¨ˆï¼ˆä¸»è¦ãªã‚‚ã®ï¼‰:
# middleware/auth.rs: 19ç®‡æ‰€ï¼ˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢é–¢æ•°ã«å¿…è¦ãª#[allow(dead_code)]ã‚’è¿½åŠ æ¸ˆã¿ï¼‰
# utils/permission.rs: 10ç®‡æ‰€
# api/dto/common.rs: 9ç®‡æ‰€
# domain/permission.rs: 8ç®‡æ‰€
# domain/role_model.rs: 5ç®‡æ‰€
# domain/team_invitation_model.rs: 5ç®‡æ‰€
# utils/transaction.rs: 4ç®‡æ‰€
# domain/organization_model.rs: 4ç®‡æ‰€
# ãã®ä»–: ç´„20ç®‡æ‰€
```

### Step 2: Phase 3å®Ÿè£…å„ªå…ˆé †ä½
1. **APIã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆcommon.rsï¼‰** â†’ å…¨APIã®åŸºç›¤ã¨ãªã‚‹ãŸã‚æœ€å„ªå…ˆ
2. **ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®é«˜åº¦åŒ–** â†’ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ä¸­æ ¸
3. **ãƒªãƒã‚¸ãƒˆãƒªå±¤ã®æœ€é©åŒ–** â†’ ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®åŠ¹ç‡åŒ–
4. **ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£æ©Ÿèƒ½** â†’ æ¨ªæ–­çš„æ©Ÿèƒ½ã®å¼·åŒ–

### Step 3: å®Ÿè£…æˆ¦ç•¥
```rust
// 1. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€
// - ApiError::newã¨with_detailsã‚’æ´»ç”¨ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¨™æº–åŒ–
// - å„ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ä¸€è²«ã—ãŸã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’å®Ÿè£…

// 2. ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®æ´»ç”¨
// - ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã«çµ±åˆ
// - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã«é›†ç´„

// 3. ãƒªãƒã‚¸ãƒˆãƒªã®æœ€é©åŒ–
// - ãƒãƒƒãƒå‡¦ç†ãƒ¡ã‚½ãƒƒãƒ‰ã®æ´»ç”¨
// - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã®æ”¹å–„
```

---

## ğŸ¯ Phase 3 ç›®æ¨™

1. **æ®‹å­˜`#[allow(dead_code)]`ã‚’50%ä»¥ä¸Šå‰Šæ¸›** (ç´„80ç®‡æ‰€â†’40ç®‡æ‰€ä»¥ä¸‹)
2. **çµ±ä¸€çš„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…**
3. **ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®å®Œå…¨æ´»ç”¨**
4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
5. **CIå®Œå…¨é€šéï¼ˆè­¦å‘Šæœ€å°åŒ–ï¼‰**

---

## ğŸ“‹ Phase 3 å®Ÿè£…ä¾‹

### 1. **çµ±ä¸€çš„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**

```rust
// âŒ ç¾åœ¨ã®å®Ÿè£…ï¼ˆåŸºæœ¬çš„ãªã‚¨ãƒ©ãƒ¼è¿”å´ï¼‰
Err(AppError::BadRequest("Invalid request".to_string()))

// âœ… æ”¹å–„å¾Œï¼ˆè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ï¼‰
Err(ApiError::validation_error()
    .with_field("email", "Invalid email format")
    .with_field("username", "Username already taken")
    .with_context("User registration failed"))
```

### 2. **ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®æ´»ç”¨**

```rust
// âŒ ç¾åœ¨ã®å®Ÿè£…ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ãŒã‚µãƒ¼ãƒ“ã‚¹å±¤ã«æ•£åœ¨ï¼‰
if invitation.status == "pending" && invitation.expires_at > Utc::now() {
    // å‡¦ç†
}

// âœ… æ”¹å–„å¾Œï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã«ãƒ­ã‚¸ãƒƒã‚¯ã‚’é›†ç´„ï¼‰
if invitation.is_valid() {
    // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ãŒçŠ¶æ…‹ç®¡ç†ã‚’æ‹…å½“
}
```

### 3. **ãƒªãƒã‚¸ãƒˆãƒªæœ€é©åŒ–**

```rust
// âŒ ç¾åœ¨ã®å®Ÿè£…ï¼ˆå€‹åˆ¥ã‚¯ã‚¨ãƒªï¼‰
for user_id in user_ids {
    let result = repo.update_user_status(user_id, status).await?;
}

// âœ… æ”¹å–„å¾Œï¼ˆãƒãƒƒãƒå‡¦ç†ï¼‰
repo.batch_update_user_status(&user_ids, status).await?
```

---
