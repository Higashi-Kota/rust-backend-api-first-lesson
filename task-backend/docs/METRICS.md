# プロジェクトメトリクス

**更新日**: 2025-01-06  
**プロジェクト**: task-backend

## ビルド時間計測結果

### 1. クリーンビルド（リリース版）
```bash
cargo clean && time cargo build --release
```

**結果**:
- ビルド時間: **13分53秒**
- CPU時間: 23分14秒（並列処理を含む）
- システム時間: 38秒

### 2. クリーンビルド（デバッグ版）
```bash
cargo clean && time cargo build
```

**結果**:
- ビルド時間: **2分7秒**
- CPU時間: 6分21秒
- システム時間: 36秒

### 3. インクリメンタルビルド
```bash
# src/main.rs に空行を追加後
echo "" >> task-backend/src/main.rs
time cargo build
```

**結果**:
- ビルド時間: **14.5秒**
- CPU時間: 12秒
- システム時間: 2秒

### 4. ビルドタイミング分析
```bash
cargo clean && cargo build --timings
```

**結果**:
- 総ビルド時間: 2分
- タイミングレポート: `/target/cargo-timings/cargo-timing-20250706T153121Z.html`

## プロジェクト概要

**総行数**: 49,649行  
**Rustファイル数**: 136ファイル  
**データベースモデル数**: 28個  
**APIエンドポイント数**: 223個  

## ディレクトリ構造とメトリクス

| ディレクトリ | ファイル数 | 行数 | 用途 |
|-------------|-----------|------|------|
| `src/api` | 38 | 22,645 | APIハンドラーとDTO |
| `src/domain` | 32 | 5,670 | ドメインモデルとビジネスエンティティ |
| `src/service` | 17 | 9,412 | ビジネスロジックとサービス層 |
| `src/repository` | 26 | 6,167 | データベースアクセス層 |
| `src/middleware` | 3 | 882 | HTTPミドルウェア（認証、CORSなど） |
| `src/utils` | 12 | 3,838 | ユーティリティ関数とヘルパー |
| `src/config` | 3 | 193 | アプリケーション設定 |
| `src/bin` | 1 | 47 | 実行可能バイナリ |

## APIハンドラー分布

| ハンドラー | エンドポイント数 | ドメイン |
|-----------|----------------|----------|
| admin_handler.rs | 37 | システム管理 |
| user_handler.rs | 22 | ユーザー管理 |
| team_invitation_handler.rs | 17 | チーム招待 |
| task_handler.rs | 15 | タスク管理 |
| organization_handler.rs | 15 | 組織管理 |
| auth_handler.rs | 15 | 認証 |
| permission_handler.rs | 14 | 権限管理 |
| organization_hierarchy_handler.rs | 13 | 組織階層 |
| subscription_handler.rs | 12 | サブスクリプション |
| team_handler.rs | 11 | チーム管理 |
| analytics_handler.rs | 11 | 分析 |
| attachment_handler.rs | 10 | ファイル添付 |
| gdpr_handler.rs | 9 | GDPR準拠 |
| payment_handler.rs | 8 | 決済処理 |
| security_handler.rs | 7 | セキュリティ機能 |
| role_handler.rs | 6 | ロール管理 |
| system_handler.rs | 1 | システム情報 |

## サービス層（17サービス）

- attachment_service.rs（添付ファイル）
- auth_service.rs（認証）
- feature_tracking_service.rs（機能追跡）
- gdpr_service.rs（GDPR）
- organization_hierarchy_service.rs（組織階層）
- organization_service.rs（組織）
- payment_service.rs（決済）
- permission_service.rs（権限）
- role_service.rs（ロール）
- security_service.rs（セキュリティ）
- storage_service.rs（ストレージ）
- subscription_service.rs（サブスクリプション）
- task_service.rs（タスク）
- team_invitation_service.rs（チーム招待）
- team_service.rs（チーム）
- user_service.rs（ユーザー）

## リポジトリ層（26リポジトリ）

主要なリポジトリ:
- ユーザー、チーム、組織リポジトリ
- タスクと添付ファイルリポジトリ
- 権限とロールリポジトリ
- 決済とサブスクリプションリポジトリ
- セキュリティとアクティビティログリポジトリ
- 分析とメトリクスリポジトリ

## モジュール間依存関係

| 依存関係タイプ | 数 | 説明 |
|--------------|-----|------|
| ハンドラー → サービス | 1 | ハンドラーからサービスへの直接インポートは最小限 |
| サービス → サービス | 2 | サービス間の結合度は低い |
| サービス → リポジトリ | 46 | サービスはリポジトリを多用 |
| リポジトリ → ドメイン | 33 | リポジトリはドメインモデルに依存 |

## 機能ドメイン分析

| 機能ドメイン | ファイル数 | 説明 |
|------------|-----------|------|
| 認証/セキュリティ | 20 | 認証、トークン、セキュリティ |
| 組織/チーム | 26 | 組織階層、チーム、部門 |
| タスク/プロジェクト | 136 | コアタスク管理（多数のファイルを含む） |
| 決済/サブスクリプション | 15 | Stripe統合、請求 |
| 分析/メトリクス | 10 | 使用状況追跡、レポート |
| 権限/ロール | 13 | RBACシステム |

## クレート分割の潜在的な機能境界

### 1. **コアドメインクレート** (`task-backend-domain`)
- すべてのドメインモデル（28モデル）
- 共有enum型と型定義
- 約5,670行

### 2. **認証/セキュリティクレート** (`task-backend-auth`)
- 認証サービス
- セキュリティミドルウェア
- トークン管理
- パスワード処理
- 約3,000-4,000行

### 3. **組織管理クレート** (`task-backend-org`)
- 組織サービス＆リポジトリ
- チームサービス＆リポジトリ
- 部門管理
- 階層管理
- 約5,000-6,000行

### 4. **タスク管理クレート** (`task-backend-tasks`)
- タスクサービス＆リポジトリ
- 添付ファイルサービス＆リポジトリ
- タスク関連ハンドラー
- 約8,000-10,000行

### 5. **決済/サブスクリプションクレート** (`task-backend-payments`)
- 決済サービス
- サブスクリプションサービス
- Stripe統合
- 請求ハンドラー
- 約3,000-4,000行

### 6. **分析/メトリクスクレート** (`task-backend-analytics`)
- 分析サービス＆リポジトリ
- メトリクス収集
- アクティビティ追跡
- 約2,000-3,000行

### 7. **共通/ユーティリティクレート** (`task-backend-common`)
- 共有ユーティリティ
- バリデーションヘルパー
- 共通DTO
- 約3,838行

### 8. **APIゲートウェイクレート** (`task-backend-api`)
- すべてのハンドラー
- DTO
- ルーティング
- ミドルウェア
- 約23,527行

## アーキテクチャの観察結果

1. **低いサービス間結合度**: サービス間依存が2つのみで、関心の分離が良好

2. **リポジトリパターン**: ビジネスロジック（サービス）とデータアクセス（リポジトリ）の明確な分離

3. **大きなAPI層**: API層（22,645行）がコードベースの45%を占め、モジュール化の可能性を示唆

4. **機能境界**: 認証、組織、タスク、決済、分析の周りに自然な境界が存在

5. **共有ドメインモデル**: すべてのモジュールがドメインモデルに依存しており、別クレートの良い候補

## クレート分割の推奨事項

1. **ドメインクレートから開始**: 他の層への依存がないため、最初にすべてのドメインモデルを抽出

2. **ユーティリティ/共通の抽出**: 共有ユーティリティと型のための共通クレートを作成

3. **機能ベースの分割**: 層ではなくビジネスドメイン（認証、組織、タスク、決済）で分割

4. **APIゲートウェイパターン**: ハンドラーを薄いAPIゲートウェイクレートに保持し、機能クレートへの呼び出しを調整

5. **段階的な移行**: コア機能に取り組む前に、結合度の低い機能（分析、決済）から開始

6. **リポジトリパターンの維持**: リポジトリインターフェースをドメインクレートに、実装を機能クレートに保持